<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Netty Client实战——高并发连接池方案"><meta name="keywords" content="连接池,netty"><meta name="author" content="egnod"><meta name="copyright" content="egnod"><title>Netty Client实战——高并发连接池方案 | EGNOD'S BLOG</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.5.6"><link rel="stylesheet" href="/css/custom.css?version=10.2.17?version=1.5.6"><link rel="stylesheet" href="/css/tabs.css?version=10.2.17?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#引言"><span class="toc-number">1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#线程模型"><span class="toc-number">2.</span> <span class="toc-text">线程模型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#同步通信机制"><span class="toc-number">3.</span> <span class="toc-text">同步通信机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NettyChannelPoolHandler-java"><span class="toc-number">3.1.</span> <span class="toc-text">NettyChannelPoolHandler.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NettyClientHandler-java"><span class="toc-number">3.2.</span> <span class="toc-text">NettyClientHandler.java</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#连接池的创建"><span class="toc-number">4.</span> <span class="toc-text">连接池的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NettyClientPool-java"><span class="toc-number">4.1.</span> <span class="toc-text">NettyClientPool.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NettyChannelPoolHandler-java-1"><span class="toc-number">4.2.</span> <span class="toc-text">NettyChannelPoolHandler.java</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#通道的动态回收"><span class="toc-number">5.</span> <span class="toc-text">通道的动态回收</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#辅助类"><span class="toc-number">6.</span> <span class="toc-text">辅助类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#常量类"><span class="toc-number">6.1.</span> <span class="toc-text">常量类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#任务连接池"><span class="toc-number">6.2.</span> <span class="toc-text">任务连接池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试类"><span class="toc-number">6.3.</span> <span class="toc-text">测试类</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">egnod</div><div class="author-info__description text-center">EGOND 个人站，主要涉及知识共享、前沿技术、生活记录共同学习等方面</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">7</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">12</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/905584.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">EGNOD'S BLOG</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">首页</a><a class="site-page" href="/archives">日志</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">目录</a><a class="site-page" href="/shenghuo">生活</a><a class="site-page" href="/photo">相册</a><a class="site-page" href="/about">关于</a></span></div><div id="post-info"><div id="post-title">Netty Client实战——高并发连接池方案</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-29</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/netty/">netty</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2.8k</span><span class="post-meta__separator">|</span><span>阅读时长: 12 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>最近研究了Netty的相关技术，用于实施高并发场景下的消息通信，期间搜集了大量资料，围绕着netty的channel连接池的设计，这个稍微有些复杂的主题，做了大量功课，其中牵扯到蛮多技术点，要想在网上找到相关的又相对完整的参考文章，确实不太容易。在此记录一下实现的方案，用于技术沉淀。</p>
<p>首先，阅读本文之前需要具备一些基础知识：</p>
<ol>
<li>socket通信和长短连接</li>
<li>知道Netty的执行流程和相关API操作 </li>
<li>理解什么是TCP半包，了解Netty提供的粘包和拆包解码器<a id="more"></a>
在此贴出一些学习过程中遇到的优秀Blog<br><a href="https://netty.io/wiki/user-guide-for-4.x.html" target="_blank" rel="noopener">官方文档</a><br><a href="https://blog.csdn.net/linsongbin1/article/details/77854957" target="_blank" rel="noopener">分隔符解码器处理半包问题</a><br><a href="https://blog.csdn.net/linsongbin1/article/details/77990882?reload" target="_blank" rel="noopener">netty实战-netty client连接池设计</a>(Netty官方新版本中已经实现了简单的连接池，可以学习连接池的设计思想)</li>
</ol>
<h1 id="线程模型"><a href="#线程模型" class="headerlink" title="线程模型"></a>线程模型</h1><p>首先，整个系统架构的线程模型如下：</p>
<p><img src="/images/pasted-46.png" alt="线程模型"></p>
<h1 id="同步通信机制"><a href="#同步通信机制" class="headerlink" title="同步通信机制"></a>同步通信机制</h1><p>其次我们需要关注单线程内的同步请求和响应<br>抛出问题：<br>Q1：如何实现基于Netty的“请求-响应”同步通信机制</p>
<blockquote>
<p>Netty提供了异步IO和同步IO的统一实现，但是我们的需求其实和IO的同步异步并无关系。我们的关键是要实现请求-响应这种典型的一问一答交互方式。用于实现微服务之间的调用和返回结果获取，要实现这个需求，需要解决两个问题：<br>a. 请求和响应的正确匹配。<br>当服务端返回响应结果的时候，怎么和客户端的请求正确匹配起来呢？解决方式：通过客户端唯一的RequestId，服务端返回的响应中需要包含该RequestId，这样客户端就可以通过RequestId来正确匹配请求响应。<br>b. 请求线程和响应线程的通信。<br>因为请求线程会在发出请求后，同步等待服务端的返回。因此，就需要解决，Netty在接受到响应之后，怎么通知请求线程结果。</p>
</blockquote>
<p>方案：使用<code>LinkedBlockingQueue</code>阻塞任务队列，使用take()获取相应的返回结果<br>首先需要对每一个请求标识一个全局唯一的标识，下面贴出核心代码：</p>
<h2 id="NettyChannelPoolHandler-java"><a href="#NettyChannelPoolHandler-java" class="headerlink" title="NettyChannelPoolHandler.java"></a><a name="NettyChannelPoolHandler.java">NettyChannelPoolHandler.java</a></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChannelTaskThread</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * netty channel池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> NettyClientPool nettyClientPool = NettyClientPool.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChannelTaskThread</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">         SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmssSSS"</span>);</span><br><span class="line">        <span class="comment">//同一个线程使用同一个全局唯一的随机数，保证从同一个池中获取和释放资源，同时使用改随机数作为Key获取返回值，时间戳+6位随机数</span></span><br><span class="line">        <span class="keyword">long</span> random = Long.valueOf(sdf.format(<span class="keyword">new</span> Date())) * <span class="number">1000000</span> + Math.round(Math.random() * <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">        Channel channel = nettyClientPool.getChannel(random);</span><br><span class="line">        log.debug(<span class="string">"在链接池池中取到的Channel： "</span>+ channel.id());</span><br><span class="line">        UnpooledByteBufAllocator allocator = <span class="keyword">new</span> UnpooledByteBufAllocator(<span class="keyword">false</span>);</span><br><span class="line">        ByteBuf buffer = allocator.buffer(<span class="number">20</span>);</span><br><span class="line">			<span class="comment">//使用固定分隔符的半包解码器</span></span><br><span class="line">        String msg = message + DataBusConstant.DELIMITER;</span><br><span class="line">        buffer.writeBytes(msg.getBytes());</span><br><span class="line">        NettyClientHandler tcpClientHandler = channel.pipeline().get(NettyClientHandler.class);</span><br><span class="line">        ChannelId id = channel.id();</span><br><span class="line">        log.info(<span class="string">"SEND SEQNO[&#123;&#125;] MESSAGE AND CHANNEL id [&#123;&#125;]"</span>,random,id);</span><br><span class="line"></span><br><span class="line">        String serverMsg = tcpClientHandler.sendMessage(buffer, channel);</span><br><span class="line">        NettyClientPool.release(channel);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"请求SEQNO["</span>+random+<span class="string">"] "</span>+ serverMsg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="NettyClientHandler-java"><a href="#NettyClientHandler-java" class="headerlink" title="NettyClientHandler.java"></a><a name="NettyClientHandler.java">NettyClientHandler.java</a></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用阻塞式LinkedBlockingQueue，对响应结果保存</span></span><br><span class="line"><span class="comment">     * 用于记录通道响应的结果集</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Long, LinkedBlockingQueue&lt;String&gt;&gt; RESULT_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendMessage</span><span class="params">(ByteBuf message,Channel ch)</span> </span>&#123;</span><br><span class="line">        LinkedBlockingQueue&lt;String&gt; linked = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//获取channel中存储的全局唯一随机值</span></span><br><span class="line">        Long randomId = ch.attr(AttributeKey.&lt;Long&gt;valueOf(DataBusConstant.RANDOM_KEY)).get();</span><br><span class="line">        RESULT_MAP.put(randomId,linked);</span><br><span class="line">        ch.writeAndFlush(message);</span><br><span class="line">        String res = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//设置3分钟的获取超时时间或者使用take()--获取不到返回结果一直阻塞</span></span><br><span class="line">            res = RESULT_MAP.get(randomId).poll(<span class="number">3</span>,TimeUnit.MINUTES);</span><br><span class="line">            RESULT_MAP.remove(randomId);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span></span>&#123;</span><br><span class="line">        String message = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(msg <span class="keyword">instanceof</span> String)&#123;</span><br><span class="line">            message = msg.toString();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(msg <span class="keyword">instanceof</span> ByteBuf)&#123;</span><br><span class="line">            message = ((ByteBuf)msg).toString(Charset.defaultCharset());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取channel中存储的全局唯一随机值</span></span><br><span class="line">        Long randomId = ctx.channel().attr(AttributeKey.&lt;Long&gt;valueOf(DataBusConstant.RANDOM_KEY)).get();</span><br><span class="line">        log.info(<span class="string">" READ INFO 服务端返回结果:"</span>+ message);</span><br><span class="line">        LinkedBlockingQueue&lt;String&gt; linked = RESULT_MAP.get(randomId);</span><br><span class="line">        linked.add(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span></span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> active = ctx.channel().isActive();</span><br><span class="line">        log.debug(<span class="string">"[此时通道状态] &#123;&#125;"</span>, active);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="连接池的创建"><a href="#连接池的创建" class="headerlink" title="连接池的创建"></a>连接池的创建</h1><p><strong>2. 官方提供的FixedChannelPool支持固定连接的连接池，但是不支持连接池的动态回收</strong><br>直接贴连接池的创建代码，通道的动态回收结合心跳机制实现：</p>
<h2 id="NettyClientPool-java"><a href="#NettyClientPool-java" class="headerlink" title="NettyClientPool.java"></a><a name="NettyClientPool.java">NettyClientPool.java</a></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="comment">//和Spring整合</span></span><br><span class="line"><span class="comment">//@Order(Integer.MAX_VALUE+1)</span></span><br><span class="line"><span class="comment">//@Component</span></span><br><span class="line"><span class="comment">//@Scope(ConfigurableBeanFactory.SCOPE_SINGLETON)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClientPool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * volatile保持线程之间的可见性，连接池的创建是单例，在这里可加可不加</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">private</span> <span class="keyword">static</span> NettyClientPool nettyClientPool;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key为目标主机的InetSocketAddress对象，value为目标主机对应的连接池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ChannelPoolMap&lt;InetSocketAddress, FixedChannelPool&gt; poolMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">    <span class="keyword">final</span> Bootstrap strap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Value("$&#123;netty.server.addresses&#125;")</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String addresses = <span class="string">"127.0.0.1:7000"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;InetSocketAddress,FixedChannelPool&gt; pools = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">private</span> <span class="keyword">static</span> List&lt;InetSocketAddress&gt; addressList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">NettyClientPool</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//如果和Spring整合，构造方法内的build方法调用注掉</span></span><br><span class="line">        build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// @Bean(initMethod = "build")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NettyClientPool <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(nettyClientPool == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (NettyClientPool.class) &#123;</span><br><span class="line">                <span class="keyword">if</span>(nettyClientPool == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    nettyClientPool = <span class="keyword">new</span> NettyClientPool();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nettyClientPool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">build</span><span class="params">()</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">"NettyClientPool build......"</span>);</span><br><span class="line">        strap.group(group).channel(NioSocketChannel.class).option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">                .option(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        poolMap = <span class="keyword">new</span> AbstractChannelPoolMap&lt;InetSocketAddress, FixedChannelPool&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> FixedChannelPool <span class="title">newPool</span><span class="params">(InetSocketAddress key)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> FixedChannelPool(strap.remoteAddress(key), <span class="keyword">new</span> NettyChannelPoolHandler(), DataBusConstant.MAX_CONNECTIONS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        getInetAddresses(addresses);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (InetSocketAddress address: addressList)&#123;</span><br><span class="line">            pools.put(address,poolMap.get(address));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;功能描述:</span></span><br><span class="line"><span class="comment">     * 根据随机数取出随机的server对应pool，从pool中取出channel</span></span><br><span class="line"><span class="comment">     *   pool.acquiredChannelCount(); 对应池中的channel数目</span></span><br><span class="line"><span class="comment">     *   连接池的动态扩容： 指定最大连接数为&#123;<span class="doctag">@link</span> Integer.MAX_VALUE&#125;,如果连接池队列中取不到channel，会自动创建channel，默认使用FIFO的获取方式，回收的channel优先被再次get到</span></span><br><span class="line"><span class="comment">     *   SERVER的宕机自动切换: 指定重试次数，get()发生连接异常，则对随机数+1，从下一个池中重新获取,</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   后期如有必要可优化为：Server注册到注册中心，从注册中心获取连接池对应的address，或者注册到zookeeper中，都需要单独写实现</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     * @方法名称 getChannel</span></span><br><span class="line"><span class="comment">     * @作者 zhangdong</span></span><br><span class="line"><span class="comment">     * @创建时间 2019/4/23 11:39</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> random</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> io.netty.channel.Channel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Channel <span class="title">getChannel</span> <span class="params">(<span class="keyword">long</span> random)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> retry = <span class="number">0</span>;</span><br><span class="line">        Channel channel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//按时间戳取余</span></span><br><span class="line">            Long poolIndex = random % pools.size();</span><br><span class="line">            InetSocketAddress address = addressList.get(poolIndex.intValue());</span><br><span class="line">            FixedChannelPool pool = pools.get(address);</span><br><span class="line">            Future&lt;Channel&gt; future = pool.acquire();</span><br><span class="line">            channel = future.get();</span><br><span class="line">            AttributeKey&lt;Long&gt; randomID = AttributeKey.valueOf(DataBusConstant.RANDOM_KEY);</span><br><span class="line">            channel.attr(randomID).set(random);</span><br><span class="line">            <span class="comment">//如果是因为服务端挂点，连接失败而获取不到channel，则随机数执行+1操作，从下一个池获取</span></span><br><span class="line">        &#125;<span class="keyword">catch</span> (ExecutionException e)&#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="comment">//每个池，尝试获取取2次</span></span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(retry &lt; addressList.size() * count)&#123;</span><br><span class="line">                retry ++;</span><br><span class="line">                <span class="keyword">return</span> getChannel( ++ random);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                log.error(<span class="string">"没有可以获取到channel连接的server，server list [&#123;&#125;]"</span>,addressList);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"没有可以获取到channel连接的server"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;功能描述:</span></span><br><span class="line"><span class="comment">     *  回收channel进池，需要保证随机值和getChannel获取到的随机值是同一个，才能从同一个pool中释放资源</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     * @方法名称 release</span></span><br><span class="line"><span class="comment">     * @作者 zhangdong</span></span><br><span class="line"><span class="comment">     * @创建时间 2019/4/23 11:16</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ch</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">(Channel ch)</span></span>&#123;</span><br><span class="line">        <span class="keyword">long</span> random = ch.attr(AttributeKey.&lt;Long&gt;valueOf(DataBusConstant.RANDOM_KEY)).get();</span><br><span class="line">        ch.flush();</span><br><span class="line">        Long poolIndex = random % pools.size();</span><br><span class="line">        pools.get(addressList.get(poolIndex.intValue())).release(ch);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线程池的hash值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ch</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getPoolHash</span><span class="params">(Channel ch)</span></span>&#123;</span><br><span class="line">        <span class="keyword">long</span> random = ch.attr(AttributeKey.&lt;Long&gt;valueOf(DataBusConstant.RANDOM_KEY)).get();</span><br><span class="line">        Long poolIndex = random % pools.size();</span><br><span class="line">        <span class="keyword">return</span> System.identityHashCode(pools.get(addressList.get(poolIndex.intValue())));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;功能描述:</span></span><br><span class="line"><span class="comment">     * 获取服务端server列表，每个server对应一个pool</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     * @方法名称 getInetAddredd</span></span><br><span class="line"><span class="comment">     * @作者 zhangdong</span></span><br><span class="line"><span class="comment">     * @创建时间 2019/4/23 11:17</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addresses</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getInetAddresses</span><span class="params">(String addresses)</span></span>&#123;</span><br><span class="line">        addressList = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(addresses))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"address列表为空"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String[] splits = addresses.split(<span class="string">","</span>);</span><br><span class="line">        <span class="keyword">for</span> (String address: splits)&#123;</span><br><span class="line">            String[] split = address.split(<span class="string">":"</span>);</span><br><span class="line">            <span class="keyword">if</span>(split.length==<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"["</span> + address + <span class="string">"]不符合IP:PORT格式"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            addressList.add(<span class="keyword">new</span> InetSocketAddress(split[<span class="number">0</span>], Integer.parseInt(split[<span class="number">1</span>])));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="NettyChannelPoolHandler-java-1"><a href="#NettyChannelPoolHandler-java-1" class="headerlink" title="NettyChannelPoolHandler.java"></a><a name="NettyChannelPoolHandler.java">NettyChannelPoolHandler.java</a></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyChannelPoolHandler</span> <span class="keyword">implements</span> <span class="title">ChannelPoolHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> ByteBuf byteBuf = Unpooled.copiedBuffer(DataBusConstant.DELIMITER.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReleased</span><span class="params">(Channel ch)</span></span>&#123;</span><br><span class="line">        ch.writeAndFlush(Unpooled.EMPTY_BUFFER);</span><br><span class="line">        log.info(<span class="string">"|--&gt;回收Channel. Channel ID: "</span> + ch.id());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelAcquired</span><span class="params">(Channel ch)</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">"|--&gt;获取Channel. Channel ID: "</span> + ch.id());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelCreated</span><span class="params">(Channel ch)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"|--&gt;创建Channel. Channel ID: "</span> + ch.id()</span><br><span class="line">                 +<span class="string">"\r\n|--&gt;创建Channel. Channel REAL HASH: "</span> + System.identityHashCode(ch));</span><br><span class="line">        SocketChannel channel = (SocketChannel) ch;</span><br><span class="line">        channel.config().setKeepAlive(<span class="keyword">true</span>);</span><br><span class="line">        channel.config().setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line">        channel.pipeline()</span><br><span class="line">                <span class="comment">//开启Netty自带的心跳处理器，每5秒发送一次心跳</span></span><br><span class="line">                .addLast(<span class="keyword">new</span> IdleStateHandler(<span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>,TimeUnit.SECONDS))</span><br><span class="line">                .addLast(<span class="keyword">new</span> DelimiterBasedFrameDecoder(Integer.MAX_VALUE,byteBuf))</span><br><span class="line">                .addLast(<span class="keyword">new</span> NettyClientHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="通道的动态回收"><a href="#通道的动态回收" class="headerlink" title="通道的动态回收"></a>通道的动态回收</h1><p><strong>3. 心跳机制的实现保证心跳不会失活，丢失心跳包的通道的管理,参考上面的 <a href="#NettyChannelPoolHandler.java">NettyChannelPoolHandler</a> 处理器</strong><br>动态通道回收，在 <a href="#NettyClientHandler.java">NettyClientHandler</a>  类中实现<code>userEventTriggered</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">static</span> Map&lt;Integer,Set&lt;Channel&gt;&gt; coreChannel = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    log.info(<span class="string">"[客户端心跳监测发送] 通道编号：&#123;&#125;"</span>, ctx.channel().id());</span><br><span class="line">    Channel channel = ctx.channel();</span><br><span class="line">    <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line">        <span class="comment">//当客户端开始发送心跳检测时。说明没有业务请求过来，释放通道数为设定的 CORE_CONNECTIONS</span></span><br><span class="line">        <span class="keyword">if</span>(channel.isActive())&#123;</span><br><span class="line">            <span class="comment">//使用pool的hash值作为Key，维护 CORE_CONNECTIONS个数个通道，多余的关闭</span></span><br><span class="line">            <span class="keyword">int</span> poolHash = NettyClientPool.getPoolHash(channel);</span><br><span class="line">            Set&lt;Channel&gt; channels = coreChannel.get(poolHash);</span><br><span class="line">            channels = channels == <span class="keyword">null</span> ? <span class="keyword">new</span> HashSet&lt;&gt;(DataBusConstant.CORE_CONNECTIONS) : channels;</span><br><span class="line">            channels.add(channel);</span><br><span class="line">            <span class="keyword">if</span>(channels.stream().filter(x-&gt; x.isActive()).count() &gt; DataBusConstant.CORE_CONNECTIONS)&#123;</span><br><span class="line">                log.info(<span class="string">"关闭 CORE_CONNECTIONS 范围之外的通道：&#123;&#125;"</span>,channel.id());</span><br><span class="line">                channels.remove(channel);</span><br><span class="line">                channel.close();</span><br><span class="line">            &#125;</span><br><span class="line">            coreChannel.put(poolHash,channels);</span><br><span class="line">        &#125;</span><br><span class="line">        String heartBeat = DataBusConstant.HEART_BEAT + DataBusConstant.DELIMITER;</span><br><span class="line">        ByteBuf byteBuf = Unpooled.copiedBuffer(heartBeat.getBytes());</span><br><span class="line">        channel.writeAndFlush(byteBuf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.userEventTriggered(ctx, evt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="辅助类"><a href="#辅助类" class="headerlink" title="辅助类"></a>辅助类</h1><h2 id="常量类"><a href="#常量类" class="headerlink" title="常量类"></a>常量类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataBusConstant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELIMITER = <span class="string">"%#_#%"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEART_BEAT = <span class="string">"ping-pong-ping-pong"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最大连接数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_CONNECTIONS = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 核心链接数，该数目内的通道 在没有业务请求时发送心跳防止失活，超过部分的通道close掉</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_CONNECTIONS = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同一个线程使用同一个全局唯一的随机数，保证从同一个池中获取和释放资源，同时使用改随机数作为Key获取返回值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RANDOM_KEY = <span class="string">"randomID"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务端丢失心跳次数，达到该次数，则关闭通道，默认3次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOOS_HEART_BEAT_COUNT = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="任务连接池"><a href="#任务连接池" class="headerlink" title="任务连接池"></a>任务连接池</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyTaskPool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池线程数量,对应CachedThreadPoolExecutor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POLL_SIZE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_POLL_SIZE = Integer.MAX_VALUE;</span><br><span class="line">	 </span><br><span class="line">    <span class="comment">//手动创建线程池</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadPoolExecutor threadPool = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            CORE_POLL_SIZE,</span><br><span class="line">            MAX_POLL_SIZE,</span><br><span class="line">            <span class="number">3</span>,</span><br><span class="line">            TimeUnit.MINUTES,</span><br><span class="line">            <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(),</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.DiscardOldestPolicy());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">submitTask</span><span class="params">(String message)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//单个任务在线程池内分配单个线程，用于同步等待封装的返回结果</span></span><br><span class="line">        Future&lt;String&gt; submit = threadPool.submit(<span class="keyword">new</span> ChannelTaskThread(message));</span><br><span class="line">        String response = submit.get();</span><br><span class="line">        log.info(<span class="string">"\n\t submitTask 返回的 Response：  \r\n\t\t[ "</span>+ response +<span class="string">" ]\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//模拟多线程客户端，提交任务，</span></span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">                       String longMsgBody = j + <span class="string">"中华人民共和国,中华人民共和国,中华人民共和国,中华人民共和国,中华人民共和国"</span> + j;</span><br><span class="line">                        NettyTaskPool.submitTask(longMsgBody);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>server端省略</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">egnod</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://itboyer.github.io/12466/">http://itboyer.github.io/12466/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://itboyer.github.io">EGNOD'S BLOG</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/连接池/">连接池</a><a class="post-meta__tags" href="/tags/netty/">netty</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share" data-disabled="google"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="next-post pull-right"><a href="/43128/"><span>JMeter测试案例[加密登录、post请求]</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"></div><div class="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="/dist/Valine.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  av: AV, 
  el: '.vcomment',
  notify: notify,
  verify: verify,
  app_id: 'Sb3I3kxloC2uM8kp7GwsFXyN-gzGzoHsz',
  app_key: 'k6Jad1ggWtw42O55GAAMbFdu',
  avatar:'robohash',
  guest_info:guest_info,
  pageSize:'10',
  placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
  lang: 'zh-cn',
  emoticon_url: '/images/alu',
  emoticon_list: ["吐.png","喷血.png","狂汗.png","不说话.png","汗.png","坐等.png","献花.png","不高兴.png","中刀.png","害羞.png","皱眉.png","小眼睛.png","中指.png","尴尬.png","瞅你.png","想一想.png","中枪.png","得意.png","肿包.png","扇耳光.png","亲亲.png","惊喜.png","脸红.png","无所谓.png","便便.png","愤怒.png","蜡烛.png","献黄瓜.png","内伤.png","投降.png","观察.png","看不见.png","击掌.png","抠鼻.png","邪恶.png","看热闹.png","口水.png","抽烟.png","锁眉.png","装大款.png","吐舌.png","无奈.png","长草.png","赞一个.png","呲牙.png","无语.png","阴暗.png","不出所料.png","咽气.png","期待.png","高兴.png","吐血倒地.png","哭泣.png","欢呼.png","黑线.png","喜极而泣.png","喷水.png","深思.png","鼓掌.png","暗地观察.png"]
})</script></div></div><footer id="footer" style="background: url(/img/905584.jpg)  no-repeat center top/cover;background-position:  bottom; "><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By egnod</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/custom.js?version=10.2.16"></script><script src="/js/particle.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>